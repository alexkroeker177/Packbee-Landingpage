---
phase: 03-frontend-and-seo
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/collections/Posts.ts
  - src/collections/KnowledgeBase.ts
  - src/collections/hooks/revalidatePost.ts
  - src/collections/hooks/revalidateKB.ts
  - src/lib/cache-tags.ts
  - payload.config.ts
  - payload-types.ts
  - src/migrations/ (new migration files)
autonomous: true

must_haves:
  truths:
    - "Posts collection has contentType field (article/tutorial) and steps[] array field visible when contentType=tutorial"
    - "KnowledgeBase collection has articleType field (standard/faq) and faqs[] array field visible when articleType=faq"
    - "plugin-search is installed and creates a search collection targeting knowledge-base"
    - "Publishing or unpublishing a post triggers revalidation of /blog/[slug] and the posts-sitemap tag"
    - "Publishing or unpublishing a KB article triggers revalidation of /help/[slug] and the kb-sitemap tag"
    - "Migration runs cleanly — all new fields and search table exist in the database"
  artifacts:
    - path: "src/collections/Posts.ts"
      provides: "contentType select field + steps[] array field + afterChange hook registration"
      contains: "contentType"
    - path: "src/collections/KnowledgeBase.ts"
      provides: "articleType select field + faqs[] array field + afterChange hook registration"
      contains: "articleType"
    - path: "src/collections/hooks/revalidatePost.ts"
      provides: "afterChange hook calling revalidatePath + revalidateTag for posts"
      exports: ["revalidatePost"]
    - path: "src/collections/hooks/revalidateKB.ts"
      provides: "afterChange hook calling revalidatePath + revalidateTag for KB articles"
      exports: ["revalidateKB"]
    - path: "src/lib/cache-tags.ts"
      provides: "Shared cache tag constants for sitemap revalidation"
      exports: ["CACHE_TAGS"]
    - path: "payload.config.ts"
      provides: "searchPlugin registered in plugins array"
      contains: "searchPlugin"
    - path: "payload-types.ts"
      provides: "Updated TypeScript types including contentType, articleType, faqs, steps"
      contains: "contentType"
  key_links:
    - from: "src/collections/hooks/revalidatePost.ts"
      to: "src/lib/cache-tags.ts"
      via: "import CACHE_TAGS"
      pattern: "import.*CACHE_TAGS.*cache-tags"
    - from: "src/collections/hooks/revalidateKB.ts"
      to: "src/lib/cache-tags.ts"
      via: "import CACHE_TAGS"
      pattern: "import.*CACHE_TAGS.*cache-tags"
    - from: "src/collections/Posts.ts"
      to: "src/collections/hooks/revalidatePost.ts"
      via: "hooks.afterChange array"
      pattern: "afterChange.*revalidatePost"
    - from: "src/collections/KnowledgeBase.ts"
      to: "src/collections/hooks/revalidateKB.ts"
      via: "hooks.afterChange array"
      pattern: "afterChange.*revalidateKB"
---

<objective>
Add structured data fields (contentType, articleType, steps[], faqs[]) to Posts and KnowledgeBase collections, install @payloadcms/plugin-search for KB search, create afterChange revalidation hooks, and run a migration to apply all schema changes.

Purpose: Phase 3 pages need contentType/articleType fields for conditional JSON-LD schemas, steps[]/faqs[] for HowTo and FAQPage structured data, search plugin for KB-05, and revalidation hooks for on-demand ISR (SEO-08). All of this must exist before any page component is written.

Output: Updated Posts.ts and KnowledgeBase.ts with new fields + hooks, revalidation hooks, cache tag constants, search plugin in config, and a clean migration.
</objective>

<execution_context>
@/Users/alexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-frontend-and-seo/03-RESEARCH.md

# Existing collection files (modify in place)
@src/collections/Posts.ts
@src/collections/KnowledgeBase.ts
@payload.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add structured data fields + install search plugin + run migration</name>
  <files>
    src/collections/Posts.ts
    src/collections/KnowledgeBase.ts
    payload.config.ts
    src/migrations/ (new files)
    payload-types.ts (generated)
  </files>
  <action>
    **1. Install @payloadcms/plugin-search:**
    ```bash
    npm install @payloadcms/plugin-search@3.77.0 --legacy-peer-deps
    ```

    **2. Add fields to Posts.ts:**

    Add a `contentType` select field AFTER `publishedAt` in the fields array:
    ```typescript
    {
      name: 'contentType',
      type: 'select',
      defaultValue: 'article',
      options: [
        { label: 'Article (standard)', value: 'article' },
        { label: 'Tutorial (HowTo schema)', value: 'tutorial' },
      ],
      admin: {
        description: 'Controls structured data (JSON-LD) schema type emitted for search engines.',
        position: 'sidebar',
      },
    }
    ```

    Add a `steps` array field AFTER `contentType`, conditional on contentType=tutorial:
    ```typescript
    {
      name: 'steps',
      type: 'array',
      admin: {
        description: 'Step-by-step instructions for HowTo structured data. Only used when Content Type is Tutorial.',
        condition: (data) => data?.contentType === 'tutorial',
      },
      fields: [
        { name: 'title', type: 'text', required: true },
        { name: 'description', type: 'textarea', required: true },
      ],
    }
    ```

    **3. Add fields to KnowledgeBase.ts:**

    Add an `articleType` select field AFTER `body` in the fields array:
    ```typescript
    {
      name: 'articleType',
      type: 'select',
      defaultValue: 'standard',
      options: [
        { label: 'Standard Article', value: 'standard' },
        { label: 'FAQ Article (FAQPage schema)', value: 'faq' },
      ],
      admin: {
        description: 'Controls structured data (JSON-LD) schema type emitted for search engines.',
        position: 'sidebar',
      },
    }
    ```

    Add a `faqs` array field AFTER `articleType`, conditional on articleType=faq:
    ```typescript
    {
      name: 'faqs',
      type: 'array',
      admin: {
        description: 'Question and answer pairs for FAQPage structured data. Only used when Article Type is FAQ.',
        condition: (data) => data?.articleType === 'faq',
      },
      fields: [
        { name: 'question', type: 'text', required: true },
        { name: 'answer', type: 'textarea', required: true },
      ],
    }
    ```

    Also add an `excerpt` textarea field AFTER `body` (before articleType) — needed for search plugin sync and meta description fallback. The KnowledgeBase collection currently lacks this field:
    ```typescript
    {
      name: 'excerpt',
      type: 'textarea',
      admin: {
        description: 'Short summary displayed in search results and used as meta description fallback.',
      },
    }
    ```

    **4. Configure search plugin in payload.config.ts:**

    Add import at top:
    ```typescript
    import { searchPlugin } from '@payloadcms/plugin-search'
    ```

    Add to the plugins array (after the seoPlugin call):
    ```typescript
    searchPlugin({
      collections: ['knowledge-base'],
      defaultPriorities: {
        'knowledge-base': 10,
      },
      searchOverrides: {
        slug: 'search',
        fields: ({ defaultFields }) => [
          ...defaultFields,
          { name: 'excerpt', type: 'textarea' },
          { name: 'section', type: 'relationship', relationTo: 'sections' },
        ],
      },
      beforeSync: ({ originalDoc, searchDoc }) => ({
        ...searchDoc,
        excerpt: (originalDoc as Record<string, unknown>)?.excerpt ?? '',
        section: (originalDoc as Record<string, unknown>)?.section,
      }),
    }),
    ```

    **5. Create and run migration:**
    ```bash
    npm run payload migrate:create -- --name add-phase3-fields
    npm run payload migrate
    ```

    **6. Generate updated types:**
    ```bash
    npm run payload generate:types
    ```
  </action>
  <verify>
    1. `npm run payload migrate` exits 0 (migration applied)
    2. `grep -c 'contentType' payload-types.ts` returns at least 1 (type generated)
    3. `grep -c 'articleType' payload-types.ts` returns at least 1
    4. `grep -c 'faqs' payload-types.ts` returns at least 1
    5. `grep -c 'steps' payload-types.ts` returns at least 1
    6. `grep 'searchPlugin' payload.config.ts` returns a match
  </verify>
  <done>Posts has contentType + steps[] fields, KnowledgeBase has excerpt + articleType + faqs[] fields, search plugin is registered in payload.config.ts, migration ran cleanly, and payload-types.ts includes all new field types</done>
</task>

<task type="auto">
  <name>Task 2: Create revalidation hooks + cache tag constants + register on collections</name>
  <files>
    src/lib/cache-tags.ts
    src/collections/hooks/revalidatePost.ts
    src/collections/hooks/revalidateKB.ts
    src/collections/Posts.ts
    src/collections/KnowledgeBase.ts
  </files>
  <action>
    **1. Create src/lib/cache-tags.ts:**
    ```typescript
    export const CACHE_TAGS = {
      POSTS_SITEMAP: 'posts-sitemap',
      KB_SITEMAP: 'kb-sitemap',
    } as const
    ```

    **2. Create src/collections/hooks/revalidatePost.ts:**
    ```typescript
    import type { CollectionAfterChangeHook } from 'payload'
    import { revalidatePath, revalidateTag } from 'next/cache'
    import type { Post } from '../../../payload-types'
    import { CACHE_TAGS } from '../../lib/cache-tags'

    export const revalidatePost: CollectionAfterChangeHook<Post> = ({
      doc,
      previousDoc,
      req: { payload, context },
    }) => {
      if (!context.disableRevalidate) {
        if (doc._status === 'published') {
          payload.logger.info(`Revalidating post: /blog/${doc.slug}`)
          revalidatePath(`/blog/${doc.slug}`)
          revalidateTag(CACHE_TAGS.POSTS_SITEMAP)
        }
        // Handle unpublishing
        if (previousDoc?._status === 'published' && doc._status !== 'published') {
          payload.logger.info(`Revalidating unpublished post: /blog/${previousDoc.slug}`)
          revalidatePath(`/blog/${previousDoc.slug}`)
          revalidateTag(CACHE_TAGS.POSTS_SITEMAP)
        }
      }
      return doc
    }
    ```

    **3. Create src/collections/hooks/revalidateKB.ts:**
    ```typescript
    import type { CollectionAfterChangeHook } from 'payload'
    import { revalidatePath, revalidateTag } from 'next/cache'
    import type { KnowledgeBase } from '../../../payload-types'
    import { CACHE_TAGS } from '../../lib/cache-tags'

    export const revalidateKB: CollectionAfterChangeHook<KnowledgeBase> = ({
      doc,
      previousDoc,
      req: { payload, context },
    }) => {
      if (!context.disableRevalidate) {
        if (doc._status === 'published') {
          payload.logger.info(`Revalidating KB article: /help/${doc.slug}`)
          revalidatePath(`/help/${doc.slug}`)
          revalidatePath('/help')
          revalidateTag(CACHE_TAGS.KB_SITEMAP)
        }
        if (previousDoc?._status === 'published' && doc._status !== 'published') {
          payload.logger.info(`Revalidating unpublished KB article: /help/${previousDoc.slug}`)
          revalidatePath(`/help/${previousDoc.slug}`)
          revalidatePath('/help')
          revalidateTag(CACHE_TAGS.KB_SITEMAP)
        }
      }
      return doc
    }
    ```

    **4. Register hooks on Posts.ts:**

    Add import at top of Posts.ts:
    ```typescript
    import { revalidatePost } from './hooks/revalidatePost'
    ```

    Add hooks property to the Posts collection config (after `versions`):
    ```typescript
    hooks: {
      afterChange: [revalidatePost],
    },
    ```

    **5. Register hooks on KnowledgeBase.ts:**

    Add import at top of KnowledgeBase.ts:
    ```typescript
    import { revalidateKB } from './hooks/revalidateKB'
    ```

    Add hooks property to the KnowledgeBase collection config (after `versions`):
    ```typescript
    hooks: {
      afterChange: [revalidateKB],
    },
    ```

    **6. Verify TypeScript compilation:**
    ```bash
    npx tsc --noEmit
    ```
    If tsc errors on unrelated files, at minimum verify:
    ```bash
    npx tsc --noEmit src/lib/cache-tags.ts src/collections/hooks/revalidatePost.ts src/collections/hooks/revalidateKB.ts 2>&1 || true
    ```
  </action>
  <verify>
    1. `grep 'revalidatePost' src/collections/Posts.ts` matches (hook registered)
    2. `grep 'revalidateKB' src/collections/KnowledgeBase.ts` matches (hook registered)
    3. `grep 'CACHE_TAGS' src/collections/hooks/revalidatePost.ts` matches (uses shared constants)
    4. `grep 'CACHE_TAGS' src/collections/hooks/revalidateKB.ts` matches (uses shared constants)
    5. Files exist: `src/lib/cache-tags.ts`, `src/collections/hooks/revalidatePost.ts`, `src/collections/hooks/revalidateKB.ts`
  </verify>
  <done>afterChange hooks revalidate /blog/[slug] and /help/[slug] on publish/unpublish, sitemap cache tags are shared constants between hooks and (future) sitemap.ts, hooks are registered on both collections</done>
</task>

</tasks>

<verification>
1. `npm run payload migrate` ran without errors
2. `payload-types.ts` contains contentType, articleType, faqs, steps types
3. All 3 new files exist: `src/lib/cache-tags.ts`, `src/collections/hooks/revalidatePost.ts`, `src/collections/hooks/revalidateKB.ts`
4. Posts.ts has `hooks: { afterChange: [revalidatePost] }` and `contentType` + `steps` fields
5. KnowledgeBase.ts has `hooks: { afterChange: [revalidateKB] }` and `articleType` + `faqs` + `excerpt` fields
6. `payload.config.ts` has `searchPlugin` in plugins array
7. `next build` succeeds (or at minimum `npx tsc --noEmit` passes on the modified/new files)
</verification>

<success_criteria>
- All schema changes are migrated to the database
- TypeScript types are regenerated and include all new fields
- Revalidation hooks are wired and will fire on publish/unpublish
- Search plugin creates a search collection for KB articles
- No TypeScript errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/03-frontend-and-seo/03-01-SUMMARY.md`
</output>
