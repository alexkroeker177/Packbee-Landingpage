---
phase: 03-frontend-and-seo
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/(marketing)/help/page.tsx
  - app/(marketing)/help/[slug]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Visiting /help shows KB articles grouped by section — each section has a heading with its articles listed below"
    - "Visiting /help with a search query filters articles and shows matching results"
    - "Visiting /help/[section-slug] shows a section landing page with the section title, description, and all articles in that section"
    - "Visiting /help/[article-slug] shows the full KB article with rich text body, breadcrumb navigation (Home > Help > Section > Article), and generateMetadata"
    - "Visiting /help/[article-slug] for an FAQ article outputs FAQPage JSON-LD with question/answer pairs from the faqs[] field"
    - "Visiting /help/[nonexistent-slug] returns a 404"
  artifacts:
    - path: "app/(marketing)/help/page.tsx"
      provides: "KB listing grouped by section with search"
      min_lines: 50
    - path: "app/(marketing)/help/[slug]/page.tsx"
      provides: "Section landing OR individual article with DB disambiguation, breadcrumbs, FAQPage JSON-LD"
      min_lines: 80
  key_links:
    - from: "app/(marketing)/help/page.tsx"
      to: "payload.find({ collection: 'search' })"
      via: "getPayload local API for search queries"
      pattern: "payload\\.find.*collection.*search"
    - from: "app/(marketing)/help/[slug]/page.tsx"
      to: "payload.find({ collection: 'sections' })"
      via: "DB disambiguation — section lookup first"
      pattern: "payload\\.find.*collection.*sections"
    - from: "app/(marketing)/help/[slug]/page.tsx"
      to: "application/ld+json"
      via: "FAQPage JSON-LD for faq articles"
      pattern: "FAQPage"
    - from: "app/(marketing)/help/[slug]/page.tsx"
      to: "@payloadcms/richtext-lexical/react"
      via: "RichText component for article body"
      pattern: "import.*RichText.*richtext-lexical/react"
---

<objective>
Build the knowledge base listing page (/help) with section grouping and search, and the combined section-landing/article page (/help/[slug]) with DB disambiguation, breadcrumb navigation, and FAQPage JSON-LD structured data.

Purpose: Delivers the public-facing knowledge base experience (KB-02, KB-03, KB-04, KB-05, KB-06, KB-07). The /help section serves both customer support docs and industry guides, grouped by section for easy navigation.

Output: Two new files — KB listing page and KB article/section page — both as Server Components using Payload Local API with the search plugin for filtering.
</objective>

<execution_context>
@/Users/alexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-frontend-and-seo/03-RESEARCH.md
@.planning/phases/03-frontend-and-seo/03-01-SUMMARY.md

# Existing layout
@app/(marketing)/layout.tsx

# Collections (for understanding the data shape)
@src/collections/KnowledgeBase.ts
@src/collections/Sections.ts

# Generated types
@payload-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: KB listing page with section grouping and search</name>
  <files>app/(marketing)/help/page.tsx</files>
  <action>
    Create `app/(marketing)/help/page.tsx` as a Server Component.

    **Data fetching (two modes: browse and search):**
    - Import `configPromise` from `@payload-config`, `getPayload` from `payload`
    - Accept `searchParams` prop: `{ searchParams: Promise<{ q?: string }> }`
    - Parse `q` param for search queries

    **Search mode (when `q` param exists):**
    - Query the `search` collection (created by plugin-search):
      ```typescript
      const results = await payload.find({
        collection: 'search',
        where: { title: { contains: q } },
        depth: 1,
        limit: 50,
        sort: '-priority',
      })
      ```
    - Render search results as a flat list with title, excerpt, and link to `/help/${result.slug ?? result.doc?.slug}`
    - Show "No results found" when empty
    - Show a "Clear search" link back to `/help`

    **Browse mode (default, no `q` param):**
    - Fetch ALL sections:
      ```typescript
      const sections = await payload.find({
        collection: 'sections',
        limit: 100,
        pagination: false,
        sort: 'title',
      })
      ```
    - For EACH section, fetch its published articles:
      ```typescript
      const articlesBySection = await Promise.all(
        sections.docs.map(async (section) => {
          const articles = await payload.find({
            collection: 'knowledge-base',
            where: {
              and: [
                { section: { equals: section.id } },
                { _status: { equals: 'published' } },
              ],
            },
            overrideAccess: false,
            depth: 0,
            select: { title: true, slug: true, excerpt: true },
            sort: 'title',
          })
          return { section, articles: articles.docs }
        })
      )
      ```
    - Only show sections that have at least one published article

    **Rendering (browse mode):**
    - Page title: "Help Center | PackBee"
    - Search bar at top: simple `<form>` with GET method and `action="/help"`:
      ```html
      <form action="/help" method="GET">
        <input type="text" name="q" placeholder="Search help articles..." defaultValue={q} />
        <button type="submit">Search</button>
      </form>
      ```
      (This is a Server Component — the form uses native HTML GET form submission, no client JS needed)
    - For each section (that has articles):
      - Section title as `<h2>` linked to `/help/${section.slug}`
      - Section description (if exists)
      - List of articles: title linked to `/help/${article.slug}`, excerpt below

    **Metadata:**
    ```typescript
    export const metadata: Metadata = {
      title: 'Help Center | PackBee',
      description: 'Find answers, tutorials, and guides about using PackBee for pick-and-pack verification.',
    }
    ```

    **Styling:** Minimal Tailwind. `max-w-4xl mx-auto px-4 py-8` container. Section headings with `text-2xl font-bold mt-8 mb-4`. Article list items with `py-2`. Design is deferred.
  </action>
  <verify>
    1. File exists at `app/(marketing)/help/page.tsx`
    2. `grep 'sections' app/(marketing)/help/page.tsx | grep 'find'` matches (fetches sections)
    3. `grep 'search' app/(marketing)/help/page.tsx` matches (search functionality)
    4. `grep 'overrideAccess: false' app/(marketing)/help/page.tsx` matches (respects access control)
    5. `grep 'form' app/(marketing)/help/page.tsx` matches (search form exists)
  </verify>
  <done>KB listing page shows articles grouped by section in browse mode, and shows search results when a query is provided. Only published articles are shown. Search uses the plugin-search collection.</done>
</task>

<task type="auto">
  <name>Task 2: KB article/section page with disambiguation, breadcrumbs, and FAQPage JSON-LD</name>
  <files>app/(marketing)/help/[slug]/page.tsx</files>
  <action>
    Create `app/(marketing)/help/[slug]/page.tsx` as a Server Component.

    This is the CRITICAL routing file — it handles BOTH section landing pages AND individual articles via a single dynamic route, using DB disambiguation.

    **Data fetching with DB disambiguation:**
    - Import `configPromise` from `@payload-config`, `getPayload` from `payload`, `RichText` from `@payloadcms/richtext-lexical/react`, `notFound` from `next/navigation`, `cache` from `react`
    - Create helper functions wrapped in `React.cache()`:

    ```typescript
    const queryBySlug = cache(async (slug: string) => {
      const payload = await getPayload({ config: configPromise })

      // Try section first
      const sections = await payload.find({
        collection: 'sections',
        where: { slug: { equals: slug } },
        limit: 1,
      })
      if (sections.docs.length > 0) {
        const section = sections.docs[0]
        const articles = await payload.find({
          collection: 'knowledge-base',
          where: {
            and: [
              { section: { equals: section.id } },
              { _status: { equals: 'published' } },
            ],
          },
          overrideAccess: false,
          depth: 0,
          select: { title: true, slug: true, excerpt: true },
          sort: 'title',
        })
        return { type: 'section' as const, section, articles: articles.docs }
      }

      // Try article
      const articles = await payload.find({
        collection: 'knowledge-base',
        where: { slug: { equals: slug } },
        limit: 1,
        depth: 1, // populate section for breadcrumbs
        overrideAccess: false,
      })
      if (articles.docs.length > 0) {
        return { type: 'article' as const, article: articles.docs[0] }
      }

      return null
    })
    ```

    **Page component:**
    ```typescript
    export default async function HelpPage({ params }: { params: Promise<{ slug: string }> }) {
      const { slug } = await params
      const data = await queryBySlug(slug)
      if (!data) notFound()

      if (data.type === 'section') {
        return <SectionLanding section={data.section} articles={data.articles} />
      }
      return <ArticlePage article={data.article} />
    }
    ```

    **SectionLanding component (inline in same file):**
    - Section title as `<h1>`
    - Section description
    - Breadcrumbs: Home > Help > {Section Title}
    - List of articles with title (linked to `/help/${article.slug}`) and excerpt

    **ArticlePage component (inline in same file):**
    - Breadcrumb navigation:
      ```html
      <nav aria-label="breadcrumb">
        <ol className="flex gap-2 text-sm text-gray-500">
          <li><a href="/">Home</a> /</li>
          <li><a href="/help">Help</a> /</li>
          <li><a href={`/help/${section.slug}`}>{section.title}</a> /</li>
          <li aria-current="page">{article.title}</li>
        </ol>
      </nav>
      ```
      (where `section` is the populated relationship from `article.section`)
    - Article title as `<h1>`
    - Article body: `<RichText data={article.body} />`
    - **FAQPage JSON-LD (conditional):** Only when `article.articleType === 'faq'` AND `article.faqs?.length > 0`:
      ```typescript
      const faqJsonLd = {
        '@context': 'https://schema.org',
        '@type': 'FAQPage',
        mainEntity: article.faqs.map((faq) => ({
          '@type': 'Question',
          name: faq.question,
          acceptedAnswer: {
            '@type': 'Answer',
            text: faq.answer,
          },
        })),
      }
      ```
      Render as `<script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(faqJsonLd).replace(/</g, '\\u003c') }} />`
    - Below the RichText body, if `article.articleType === 'faq'` and faqs exist, also render the FAQs as visible HTML:
      ```html
      <section>
        <h2>Frequently Asked Questions</h2>
        {article.faqs.map((faq) => (
          <div key={faq.id}>
            <h3>{faq.question}</h3>
            <p>{faq.answer}</p>
          </div>
        ))}
      </section>
      ```

    **generateMetadata:**
    - Call `queryBySlug(slug)` and return appropriate metadata:
      - For sections: `{ title: \`${section.title} | Help | PackBee\`, description: section.description }`
      - For articles: use `article.meta?.title`, `article.meta?.description`, `article.meta?.noIndex`, `article.meta?.canonicalURL`, openGraph, etc. (same pattern as blog post generateMetadata)
      - For not found: return `{}`

    **generateStaticParams:**
    - Fetch all section slugs + all published KB article slugs:
      ```typescript
      export async function generateStaticParams() {
        const payload = await getPayload({ config: configPromise })
        const [sections, articles] = await Promise.all([
          payload.find({ collection: 'sections', limit: 100, pagination: false, select: { slug: true } }),
          payload.find({ collection: 'knowledge-base', draft: false, limit: 1000, overrideAccess: false, pagination: false, select: { slug: true } }),
        ])
        return [
          ...sections.docs.map(({ slug }) => ({ slug })),
          ...articles.docs.map(({ slug }) => ({ slug })),
        ]
      }
      ```

    **Styling:** Minimal Tailwind. `max-w-4xl mx-auto px-4 py-8` container. Breadcrumbs with `flex gap-2 text-sm`. Design is deferred.
  </action>
  <verify>
    1. File exists at `app/(marketing)/help/[slug]/page.tsx`
    2. `grep 'sections' app/(marketing)/help/[slug]/page.tsx | grep 'find'` matches (section lookup for disambiguation)
    3. `grep 'knowledge-base' app/(marketing)/help/[slug]/page.tsx | grep 'find'` matches (article lookup)
    4. `grep 'breadcrumb' app/(marketing)/help/[slug]/page.tsx` matches (breadcrumb nav)
    5. `grep 'FAQPage' app/(marketing)/help/[slug]/page.tsx` matches (FAQPage JSON-LD)
    6. `grep 'RichText' app/(marketing)/help/[slug]/page.tsx` matches (rich text rendering)
    7. `grep 'notFound' app/(marketing)/help/[slug]/page.tsx` matches (404 handling)
    8. `grep 'generateMetadata' app/(marketing)/help/[slug]/page.tsx` matches
    9. `grep 'generateStaticParams' app/(marketing)/help/[slug]/page.tsx` matches
  </verify>
  <done>Single /help/[slug] route handles both section landing pages and individual articles via DB disambiguation. Articles have breadcrumbs and FAQPage JSON-LD when articleType=faq. Section pages list their articles. 404 returned for non-existent slugs.</done>
</task>

</tasks>

<verification>
1. `app/(marketing)/help/page.tsx` exists with section grouping AND search functionality
2. `app/(marketing)/help/[slug]/page.tsx` exists and handles BOTH sections and articles
3. Breadcrumb navigation present on article pages (KB-04)
4. FAQPage JSON-LD present for faq-type articles (KB-07)
5. Search form on /help queries the search collection (KB-05)
6. Section landing pages show section title + articles (KB-06)
7. All queries use `overrideAccess: false` (no draft leakage)
8. `next build` succeeds (or at minimum no TypeScript errors in the new files)
</verification>

<success_criteria>
- /help shows articles grouped by section with a working search form
- /help/[section-slug] shows a section landing page with its articles
- /help/[article-slug] shows the article with breadcrumbs and rich text
- FAQ articles output FAQPage JSON-LD with structured question/answer pairs
- Non-existent slugs return 404
- All pages use overrideAccess: false to prevent draft leakage
</success_criteria>

<output>
After completion, create `.planning/phases/03-frontend-and-seo/03-03-SUMMARY.md`
</output>
