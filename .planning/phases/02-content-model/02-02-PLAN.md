---
phase: 02-content-model
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/collections/KnowledgeBase.ts
  - payload.config.ts
  - src/migrations/index.ts
autonomous: false

must_haves:
  truths:
    - "KnowledgeBase collection appears in admin sidebar with title, slug, body, section relationship, and status fields"
    - "KB articles have Save Draft and Publish buttons (drafts enabled)"
    - "KB articles show version history tab"
    - "KB articles have SEO tab with meta title, description, image, canonical URL, OG title, noIndex"
    - "KB articles have a Live Preview button in the admin toolbar"
    - "An editor can create and publish a blog post with all fields — it appears as published in the admin list"
    - "An editor can create and publish a KB article with section grouping — it appears as published in the admin list"
    - "Version history shows multiple versions after editing a published post"
    - "Scheduled publish date picker is visible on posts"
  artifacts:
    - path: "src/collections/KnowledgeBase.ts"
      provides: "KB article collection with editorial workflow and section relationship"
      contains: "slug: 'knowledge-base'"
    - path: "payload.config.ts"
      provides: "All 7 collections registered, SEO plugin active on posts and knowledge-base"
      contains: "KnowledgeBase"
  key_links:
    - from: "src/collections/KnowledgeBase.ts"
      to: "src/collections/Sections.ts"
      via: "relationship field relationTo: 'sections'"
      pattern: "relationTo: 'sections'"
    - from: "payload.config.ts"
      to: "src/collections/KnowledgeBase.ts"
      via: "collections array import"
      pattern: "import.*KnowledgeBase.*from.*collections/KnowledgeBase"
---

<objective>
Create the KnowledgeBase article collection with full editorial workflow (drafts, versions, autosave, live preview, section grouping via relationship to Sections), register it in payload.config.ts, run a database migration, and verify all Phase 2 collections work in the admin panel.

Purpose: This plan completes the content model. After completion, editors can author both blog posts and KB articles with full editorial workflow and SEO metadata. All Phase 2 success criteria are satisfied.

Output: KnowledgeBase collection file, updated payload.config.ts, successful migration, and verified admin panel functionality.
</objective>

<execution_context>
@/Users/alexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-model/02-RESEARCH.md
@.planning/phases/02-content-model/02-01-SUMMARY.md
@payload.config.ts
@src/collections/Posts.ts
@src/collections/Sections.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KnowledgeBase collection, register in config, and run migration</name>
  <files>
    src/collections/KnowledgeBase.ts
    payload.config.ts
    src/migrations/index.ts
  </files>
  <action>
1. Create `src/collections/KnowledgeBase.ts` (KB-01, EDIT-01, EDIT-02, EDIT-03):
   ```typescript
   import type { CollectionConfig } from 'payload'
   import { slugField } from 'payload'
   import { lexicalEditor } from '@payloadcms/richtext-lexical'

   export const KnowledgeBase: CollectionConfig = {
     slug: 'knowledge-base',
     access: {
       read: ({ req }) => {
         if (req.user) return true
         return { _status: { equals: 'published' } }
       },
       create: ({ req }) => Boolean(req.user),
       update: ({ req }) => Boolean(req.user),
       delete: ({ req }) => Boolean(req.user),
       readVersions: ({ req }) => Boolean(req.user),
     },
     admin: {
       useAsTitle: 'title',
       defaultColumns: ['title', 'slug', 'section', '_status', 'updatedAt'],
       livePreview: {
         url: ({ data }) =>
           `${process.env.NEXT_PUBLIC_SERVER_URL ?? ''}/help/${data?.slug ?? ''}`,
       },
       preview: (data) =>
         `${process.env.NEXT_PUBLIC_SERVER_URL ?? ''}/help/${typeof data === 'object' && data && 'slug' in data ? data.slug : ''}`,
     },
     versions: {
       maxPerDoc: 50,
       drafts: {
         autosave: {
           interval: 100,
         },
       },
     },
     fields: [
       {
         name: 'title',
         type: 'text',
         required: true,
       },
       ...slugField(),
       {
         name: 'section',
         type: 'relationship',
         relationTo: 'sections',
         required: true,
         admin: {
           description: 'The knowledge base section this article belongs to.',
         },
       },
       {
         name: 'body',
         type: 'richText',
         editor: lexicalEditor(),
       },
     ],
   }
   ```

   Key differences from Posts:
   - No `schedulePublish` — KB articles don't need scheduled publishing (not in requirements). Versions/drafts are still enabled (EDIT-01, EDIT-02).
   - Has `section` relationship to `'sections'` collection (KB-01 section grouping)
   - No `excerpt`, `featuredImage`, `author`, `categories`, `tags`, `publishedAt` fields — KB articles are simpler
   - Live preview URL points to `/help/[slug]` instead of `/blog/[slug]`

2. Update `payload.config.ts`:
   - Add import: `import { KnowledgeBase } from './src/collections/KnowledgeBase'`
   - Add `KnowledgeBase` to the `collections` array (after Posts): `[Users, Media, Authors, Categories, Sections, Posts, KnowledgeBase]`
   - The SEO plugin already targets `'knowledge-base'` from Plan 02-01 — no plugin changes needed.

3. Run migration:
   ```bash
   npx payload migrate:create --name phase-2-knowledge-base
   ```

4. After `migrate:create`, verify `src/migrations/index.ts` includes the new migration. If it was NOT auto-updated, manually add the new migration import and entry.

5. Run the migration:
   ```bash
   npx payload migrate
   ```

6. Regenerate types:
   ```bash
   npx payload generate:types
   ```

7. Verify the build passes:
   ```bash
   npm run build
   ```
  </action>
  <verify>
- `src/collections/KnowledgeBase.ts` exists with `slug: 'knowledge-base'`, `versions.drafts`, `section` relationship to `'sections'`
- `payload.config.ts` imports and registers KnowledgeBase (7 collections total)
- Migration ran successfully: `npx payload migrate` exits with 0
- `npm run build` passes without errors
  </verify>
  <done>KnowledgeBase collection exists with editorial workflow (drafts, versions, autosave, live preview) and section grouping via relationship. It is registered in payload.config.ts and the database migration is applied. Build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
All Phase 2 collections are implemented: Authors, Categories, Sections, Posts (with full editorial workflow), and KnowledgeBase (with section grouping). SEO plugin is active on Posts and KnowledgeBase. Jobs queue is configured for scheduled publishing.
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Visit `http://localhost:3000/admin` and log in

3. **Verify collections in sidebar:**
   - Authors, Categories, Sections, Posts, Knowledge Base should all appear

4. **Test Posts collection (BLOG-01, BLOG-04, BLOG-05, EDIT-01, EDIT-02, EDIT-03, EDIT-04):**
   a. Create a new post — verify fields: title, slug (auto-generated), excerpt, featured image, body (rich text editor), author (dropdown from Authors), categories (multi-select from Categories), tags (multi-value text), published at (date picker)
   b. Save as draft — verify "Draft" status badge appears
   c. Publish the post — verify "Published" status badge appears
   d. Edit the published post and check the Versions tab — verify version history shows at least 2 versions
   e. Check the SEO tab — verify meta title, meta description, OG image, Canonical URL, OG Title Override, No Index fields are present
   f. Check for Live Preview button in admin toolbar (it will show a 404 iframe — this is expected, routes are Phase 3)
   g. Check for schedule publish option — verify a date/time picker is available for future publishing

5. **Test KnowledgeBase collection (KB-01, EDIT-01, EDIT-02, EDIT-03):**
   a. First create a Section (e.g., "Getting Started")
   b. Create a new KB article — verify fields: title, slug, section (relationship dropdown showing your section), body (rich text editor)
   c. Save as draft, then publish — verify status transitions work
   d. Check the SEO tab — same fields as Posts
   e. Check for Live Preview button

6. **Test supporting collections:**
   a. Create an Author with name, role, bio, and avatar (upload an image)
   b. Create a Category — verify slug auto-generates from title
   c. Verify the author and category appear as selectable options when editing a Post
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
After both tasks and checkpoint complete:
1. All 7 collections visible in admin panel (Users, Media, Authors, Categories, Sections, Posts, Knowledge Base)
2. A blog post can be created with all BLOG-01 through BLOG-05 fields and published
3. A KB article can be created with section grouping and published
4. Draft/publish workflow works on both Posts and KnowledgeBase (EDIT-01)
5. Version history shows multiple versions (EDIT-02)
6. Live Preview button is present in admin toolbar for Posts and KB (EDIT-03 — 404 iframe is expected)
7. Scheduled publish date picker is available on Posts (EDIT-04)
8. SEO tab has meta title, description, image, canonical URL, OG title, noIndex on both collections (SEO-01, SEO-02, SEO-03, SEO-09, SEO-10)
</verification>

<success_criteria>
- Phase 2 Success Criterion 1: An editor can create a blog post with title, rich text body, excerpt, featured image, author, categories, tags, and publish it
- Phase 2 Success Criterion 2: An editor can create a KB article with title, body, section grouping, and publish it
- Phase 2 Success Criterion 3: An editor can save a post as a draft, make changes, and the version history shows both versions
- Phase 2 Success Criterion 4: A previously published post can be previewed live in the admin panel (button present, 404 iframe expected until Phase 3)
- Phase 2 Success Criterion 5: A post can be scheduled for future publishing and the admin panel shows the scheduled time
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-model/02-02-SUMMARY.md`
</output>
