---
phase: 02-content-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/collections/Authors.ts
  - src/collections/Categories.ts
  - src/collections/Sections.ts
  - src/collections/Posts.ts
  - payload.config.ts
  - src/migrations/index.ts
autonomous: true

must_haves:
  truths:
    - "Authors collection appears in admin sidebar with name, role, bio, avatar fields"
    - "Categories collection appears in admin sidebar with title and auto-generated slug"
    - "Sections collection appears in admin sidebar with title and auto-generated slug"
    - "Posts collection appears in admin sidebar with title, slug, excerpt, body, featuredImage, author, categories, tags, publishedAt fields"
    - "Posts have Save Draft and Publish buttons (drafts enabled)"
    - "Posts show version history tab"
    - "Posts have SEO tab with meta title, description, image, canonical URL, OG title, noIndex"
    - "Posts have a Live Preview button in the admin toolbar"
    - "Posts have a schedule publish date picker"
  artifacts:
    - path: "src/collections/Authors.ts"
      provides: "Author profiles collection"
      contains: "slug: 'authors'"
    - path: "src/collections/Categories.ts"
      provides: "Blog categories collection with slugField"
      contains: "slug: 'categories'"
    - path: "src/collections/Sections.ts"
      provides: "KB section grouping collection with slugField"
      contains: "slug: 'sections'"
    - path: "src/collections/Posts.ts"
      provides: "Blog posts with editorial workflow, SEO, live preview"
      contains: "slug: 'posts'"
    - path: "payload.config.ts"
      provides: "All collections registered, SEO plugin, jobs.autoRun"
      contains: "seoPlugin"
    - path: "package.json"
      provides: "@payloadcms/plugin-seo@3.77.0 dependency"
      contains: "@payloadcms/plugin-seo"
  key_links:
    - from: "src/collections/Posts.ts"
      to: "src/collections/Authors.ts"
      via: "relationship field relationTo: 'authors'"
      pattern: "relationTo: 'authors'"
    - from: "src/collections/Posts.ts"
      to: "src/collections/Categories.ts"
      via: "relationship field relationTo: 'categories'"
      pattern: "relationTo: 'categories'"
    - from: "payload.config.ts"
      to: "src/collections/Posts.ts"
      via: "collections array import"
      pattern: "import.*Posts.*from.*collections/Posts"
    - from: "payload.config.ts"
      to: "@payloadcms/plugin-seo"
      via: "seoPlugin in plugins array"
      pattern: "seoPlugin\\("
---

<objective>
Create all supporting collections (Authors, Categories, Sections), the Posts collection with full editorial workflow (drafts, versions, autosave, scheduled publishing, live preview), install and configure the SEO plugin, add jobs.autoRun for scheduled publishing, and run a database migration.

Purpose: This plan delivers the core blog content model. After completion, editors can create author profiles, categories, KB sections, and full blog posts with draft/publish workflow and SEO metadata in the admin panel.

Output: Four new collection files, updated payload.config.ts with SEO plugin and jobs config, and a successful database migration.
</objective>

<execution_context>
@/Users/alexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-model/02-RESEARCH.md
@payload.config.ts
@src/collections/Users.ts
@src/collections/Media.ts
@src/migrations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install SEO plugin and create Authors, Categories, Sections collections</name>
  <files>
    package.json
    src/collections/Authors.ts
    src/collections/Categories.ts
    src/collections/Sections.ts
  </files>
  <action>
1. Install the SEO plugin pinned to 3.77.0:
   ```bash
   npm install @payloadcms/plugin-seo@3.77.0 --legacy-peer-deps
   ```
   Verify `package.json` shows `"@payloadcms/plugin-seo": "3.77.0"` exactly.

2. Create `src/collections/Authors.ts` (BLOG-02):
   ```typescript
   import type { CollectionConfig } from 'payload'

   export const Authors: CollectionConfig = {
     slug: 'authors',
     access: {
       read: () => true,
       create: ({ req }) => Boolean(req.user),
       update: ({ req }) => Boolean(req.user),
       delete: ({ req }) => Boolean(req.user),
     },
     admin: {
       useAsTitle: 'name',
       defaultColumns: ['name', 'role', 'updatedAt'],
     },
     fields: [
       {
         name: 'name',
         type: 'text',
         required: true,
       },
       {
         name: 'role',
         type: 'text',
       },
       {
         name: 'bio',
         type: 'textarea',
       },
       {
         name: 'avatar',
         type: 'upload',
         relationTo: 'media',
       },
     ],
   }
   ```

3. Create `src/collections/Categories.ts` (BLOG-03):
   ```typescript
   import type { CollectionConfig } from 'payload'
   import { slugField } from 'payload'

   export const Categories: CollectionConfig = {
     slug: 'categories',
     access: {
       read: () => true,
       create: ({ req }) => Boolean(req.user),
       update: ({ req }) => Boolean(req.user),
       delete: ({ req }) => Boolean(req.user),
     },
     admin: {
       useAsTitle: 'title',
     },
     fields: [
       {
         name: 'title',
         type: 'text',
         required: true,
       },
       ...slugField(),
     ],
   }
   ```

4. Create `src/collections/Sections.ts` (KB-01 section grouping — using a collection instead of a select field so Phase 3 can use `/help/[section-slug]` routes with their own slugs):
   ```typescript
   import type { CollectionConfig } from 'payload'
   import { slugField } from 'payload'

   export const Sections: CollectionConfig = {
     slug: 'sections',
     access: {
       read: () => true,
       create: ({ req }) => Boolean(req.user),
       update: ({ req }) => Boolean(req.user),
       delete: ({ req }) => Boolean(req.user),
     },
     admin: {
       useAsTitle: 'title',
     },
     fields: [
       {
         name: 'title',
         type: 'text',
         required: true,
       },
       ...slugField(),
       {
         name: 'description',
         type: 'textarea',
         admin: {
           description: 'Short description shown on the section landing page.',
         },
       },
     ],
   }
   ```
  </action>
  <verify>
- `package.json` contains `"@payloadcms/plugin-seo": "3.77.0"`
- `src/collections/Authors.ts` exists and exports an `Authors` CollectionConfig with slug `'authors'`
- `src/collections/Categories.ts` exists and exports a `Categories` CollectionConfig with slug `'categories'` and `...slugField()`
- `src/collections/Sections.ts` exists and exports a `Sections` CollectionConfig with slug `'sections'` and `...slugField()`
  </verify>
  <done>Three supporting collections (Authors, Categories, Sections) are created as TypeScript files and the SEO plugin is installed at version 3.77.0.</done>
</task>

<task type="auto">
  <name>Task 2: Create Posts collection, update payload.config.ts, and run migration</name>
  <files>
    src/collections/Posts.ts
    payload.config.ts
    src/migrations/index.ts
  </files>
  <action>
1. Create `src/collections/Posts.ts` with full editorial workflow (BLOG-01, BLOG-04, BLOG-05, EDIT-01, EDIT-02, EDIT-03, EDIT-04):
   ```typescript
   import type { CollectionConfig } from 'payload'
   import { slugField } from 'payload'
   import { lexicalEditor } from '@payloadcms/richtext-lexical'

   export const Posts: CollectionConfig = {
     slug: 'posts',
     access: {
       read: ({ req }) => {
         if (req.user) return true
         return { _status: { equals: 'published' } }
       },
       create: ({ req }) => Boolean(req.user),
       update: ({ req }) => Boolean(req.user),
       delete: ({ req }) => Boolean(req.user),
       readVersions: ({ req }) => Boolean(req.user),
     },
     admin: {
       useAsTitle: 'title',
       defaultColumns: ['title', 'slug', 'author', '_status', 'updatedAt'],
       livePreview: {
         url: ({ data }) =>
           `${process.env.NEXT_PUBLIC_SERVER_URL ?? ''}/blog/${data?.slug ?? ''}`,
       },
       preview: (data) =>
         `${process.env.NEXT_PUBLIC_SERVER_URL ?? ''}/blog/${typeof data === 'object' && data && 'slug' in data ? data.slug : ''}`,
     },
     versions: {
       maxPerDoc: 50,
       drafts: {
         autosave: {
           interval: 100,
         },
         schedulePublish: true,
       },
     },
     fields: [
       {
         name: 'title',
         type: 'text',
         required: true,
       },
       ...slugField(),
       {
         name: 'excerpt',
         type: 'textarea',
       },
       {
         name: 'featuredImage',
         type: 'upload',
         relationTo: 'media',
       },
       {
         name: 'body',
         type: 'richText',
         editor: lexicalEditor(),
       },
       {
         name: 'author',
         type: 'relationship',
         relationTo: 'authors',
       },
       {
         name: 'categories',
         type: 'relationship',
         relationTo: 'categories',
         hasMany: true,
       },
       {
         name: 'tags',
         type: 'text',
         hasMany: true,
       },
       {
         name: 'publishedAt',
         type: 'date',
         admin: {
           date: { pickerAppearance: 'dayAndTime' },
         },
       },
     ],
   }
   ```

   Key points:
   - `versions.drafts` enables EDIT-01 (draft/publish) and EDIT-02 (version history)
   - `versions.drafts.autosave` enables autosave for editor comfort
   - `versions.drafts.schedulePublish` enables EDIT-04 (scheduled publishing)
   - `admin.livePreview` enables EDIT-03 (live preview — will show 404 until Phase 3 routes exist, this is expected)
   - `access.read` returns published-only filter for unauthenticated requests
   - `readVersions` restricts version history to authenticated users
   - Do NOT manually add a `_status` field — Payload injects it automatically when drafts is enabled
   - Use `...slugField()` (spread) — it returns a RowField

2. Update `payload.config.ts` to:
   - Import all new collections (Authors, Categories, Sections, Posts)
   - Import `seoPlugin` from `'@payloadcms/plugin-seo'`
   - Add all collections to the `collections` array: `[Users, Media, Authors, Categories, Sections, Posts]`
   - Configure the SEO plugin in the `plugins` array (SEO-01, SEO-02, SEO-03, SEO-09, SEO-10):
     ```typescript
     plugins: [
       seoPlugin({
         collections: ['posts', 'knowledge-base'],
         uploadsCollection: 'media',
         tabbedUI: true,
         generateTitle: ({ doc }) =>
           doc?.title ? `${doc.title} | PackBee` : 'PackBee',
         generateDescription: ({ doc }) =>
           (doc as Record<string, unknown>)?.excerpt as string ?? '',
         generateURL: ({ doc, collectionSlug }) =>
           collectionSlug === 'posts'
             ? `${process.env.NEXT_PUBLIC_SERVER_URL ?? ''}/blog/${(doc as Record<string, unknown>)?.slug ?? ''}`
             : `${process.env.NEXT_PUBLIC_SERVER_URL ?? ''}/help/${(doc as Record<string, unknown>)?.slug ?? ''}`,
         fields: [
           {
             name: 'canonicalURL',
             type: 'text',
             label: 'Canonical URL',
             admin: {
               description: 'Override the canonical URL for this page. Leave blank to use the default URL.',
             },
           },
           {
             name: 'ogTitle',
             type: 'text',
             label: 'OG Title Override',
             admin: {
               description: 'Override the social sharing title. Defaults to SEO Title if blank.',
             },
           },
           {
             name: 'noIndex',
             type: 'checkbox',
             label: 'No Index',
             defaultValue: false,
             admin: {
               description: 'Check to exclude this page from search engine indexing and the sitemap.',
             },
           },
         ],
       }),
     ],
     ```
     Note: `'knowledge-base'` is included in `collections` now (pre-configured for Plan 02-02). The SEO plugin will skip collections that don't exist yet — this is safe.
   - Add `jobs.autoRun` config to `buildConfig` (EDIT-04 — required for scheduled publishing to actually process):
     ```typescript
     jobs: {
       autoRun: [
         {
           cron: '* * * * *',
           queue: 'default',
           limit: 10,
         },
       ],
       deleteJobOnComplete: true,
     },
     ```

3. Run migration to create database tables for the new collections:
   ```bash
   npx payload migrate:create --name phase-2-posts-and-supporting
   ```

4. After `migrate:create`, verify `src/migrations/index.ts` includes the new migration. If it was NOT auto-updated, manually add the new migration import and entry to the exports array.

5. Run the migration:
   ```bash
   npx payload migrate
   ```

6. Regenerate types:
   ```bash
   npx payload generate:types
   ```
  </action>
  <verify>
- `src/collections/Posts.ts` exists with `slug: 'posts'`, `versions.drafts`, `schedulePublish: true`, `admin.livePreview`
- `payload.config.ts` imports and registers Authors, Categories, Sections, Posts collections
- `payload.config.ts` has `seoPlugin(...)` in `plugins` array with `canonicalURL`, `ogTitle`, `noIndex` custom fields
- `payload.config.ts` has `jobs.autoRun` config
- Migration ran successfully: `npx payload migrate` exits with 0
- No TypeScript errors: `npx tsc --noEmit` passes (or `npm run build` succeeds)
  </verify>
  <done>Posts collection exists with full editorial workflow (drafts, versions, autosave, scheduled publish, live preview). SEO plugin is configured with custom fields (canonical URL, OG title, noIndex). Jobs queue is configured for scheduled publishing. Database migration is applied. All four new collections plus SEO plugin are registered in payload.config.ts.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm run build` succeeds without errors
2. All collection files exist: Authors.ts, Categories.ts, Sections.ts, Posts.ts
3. `payload.config.ts` registers 6 collections (Users, Media, Authors, Categories, Sections, Posts)
4. `payload.config.ts` has seoPlugin in plugins array targeting 'posts' and 'knowledge-base'
5. `payload.config.ts` has jobs.autoRun config
6. Database migration applied successfully
7. `package.json` contains `"@payloadcms/plugin-seo": "3.77.0"`
</verification>

<success_criteria>
- Four new collection files created and registered in payload.config.ts
- SEO plugin installed at 3.77.0 and configured with canonical URL, OG title override, and noIndex custom fields
- Posts collection has versions with drafts, autosave, schedulePublish, and live preview configured
- Jobs queue autoRun is configured for scheduled publish processing
- Database migration created and applied successfully
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-model/02-01-SUMMARY.md`
</output>
