---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(marketing)/layout.tsx
  - app/(marketing)/page.tsx
  - app/globals.css
  - app/(payload)/layout.tsx
  - app/(payload)/custom.scss
  - app/(payload)/admin/importMap.js
  - app/(payload)/admin/[[...segments]]/page.tsx
  - app/(payload)/admin/[[...segments]]/not-found.tsx
  - app/(payload)/api/[...slug]/route.ts
  - next.config.mjs
  - tsconfig.json
  - payload.config.ts
  - src/collections/Users.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "Visiting `/` renders the existing landing page identically — fonts, animations, layout unchanged"
    - "Visiting `/admin` shows the Payload admin panel login screen with no CSS bleed from Tailwind"
    - "`npm run build` completes without errors"
  artifacts:
    - path: "app/(marketing)/layout.tsx"
      provides: "Landing page layout with globals.css import and Google Fonts"
      contains: "globals.css"
    - path: "app/(marketing)/page.tsx"
      provides: "Landing page entry point"
      contains: "@/components/"
    - path: "app/(payload)/layout.tsx"
      provides: "Payload admin layout with RootLayout"
      contains: "@payloadcms/next/layouts"
    - path: "app/(payload)/admin/[[...segments]]/page.tsx"
      provides: "Payload admin page renderer"
      contains: "RootPage"
    - path: "app/(payload)/api/[...slug]/route.ts"
      provides: "Payload REST API routes"
      contains: "REST_GET"
    - path: "payload.config.ts"
      provides: "Payload CMS configuration"
      contains: "buildConfig"
    - path: "next.config.mjs"
      provides: "Next.js config wrapped with withPayload"
      contains: "withPayload"
    - path: "src/collections/Users.ts"
      provides: "Users collection with auth for admin login"
      contains: "auth: true"
  key_links:
    - from: "app/(payload)/layout.tsx"
      to: "payload.config.ts"
      via: "import config from '@payload-config'"
      pattern: "@payload-config"
    - from: "tsconfig.json"
      to: "payload.config.ts"
      via: "paths alias @payload-config"
      pattern: "@payload-config.*payload\\.config\\.ts"
    - from: "next.config.mjs"
      to: "@payloadcms/next/withPayload"
      via: "withPayload wrapper"
      pattern: "withPayload"
---

<objective>
Restructure the existing landing page into a `(marketing)` route group, install Payload CMS 3.77.0, and create the `(payload)` route group with all boilerplate files so that both the landing page and the Payload admin panel run in the same Next.js app with complete CSS isolation.

Purpose: Establishes the dual route group architecture that prevents CSS bleed between Tailwind (landing page) and Payload's admin panel, and installs all Payload dependencies so the admin panel is accessible at `/admin`.

Output: Working Next.js app where `/` serves the unchanged landing page and `/admin` serves the Payload admin login screen.
</objective>

<execution_context>
@/Users/alexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route group restructure and Payload package installation</name>
  <files>
    app/(marketing)/layout.tsx
    app/(marketing)/page.tsx
    app/globals.css (stays in place)
    next.config.mjs (new, replaces next.config.ts)
    tsconfig.json
    package.json
  </files>
  <action>
**Step 1 — Create route group and move files:**

1. Create directory `app/(marketing)/`
2. Move `app/layout.tsx` to `app/(marketing)/layout.tsx`
3. Move `app/page.tsx` to `app/(marketing)/page.tsx`
4. Delete the original `app/layout.tsx` and `app/page.tsx` (confirm they are gone — having both causes route conflicts)
5. `app/globals.css` stays at `app/globals.css`
6. In `app/(marketing)/layout.tsx`, update the CSS import path from `"./globals.css"` to `"../globals.css"` (one directory up from the route group)

**IMPORTANT:** Do NOT create a root `app/layout.tsx`. The `(marketing)` route group has its own layout with `<html>` and `<body>` tags. The `(payload)` route group will also have its own layout. No root layout is needed, and having one that imports `globals.css` would cause CSS bleed into the admin panel. Next.js 16 does not require a root layout when all routes are inside route groups.

**Step 2 — Rename next.config.ts to next.config.mjs:**

Delete `next.config.ts` and create `next.config.mjs` with this exact content:

```javascript
import { withPayload } from '@payloadcms/next/withPayload'

/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      { hostname: "images.unsplash.com" },
      { hostname: "picsum.photos" },
      { hostname: "ui-avatars.com" },
    ],
  },
}

export default withPayload(nextConfig, { devBundleServerPackages: false })
```

The `devBundleServerPackages: false` option (second argument to `withPayload`, NOT inside `nextConfig`) prevents Next.js from bundling Payload's server packages during dev compilation, cutting compile times significantly.

**Step 3 — Update tsconfig.json:**

Add the `@payload-config` path alias to the existing `paths` object. Do NOT remove the existing `@/*` alias. The result should be:

```json
"paths": {
  "@/*": ["./*"],
  "@payload-config": ["./payload.config.ts"]
}
```

**Step 4 — Pin Next.js version and install Payload packages:**

First, check what version of Next.js is currently resolved:
```bash
node -e "console.log(require('./node_modules/next/package.json').version)"
```

Pin Next.js to that exact version in `package.json` (replace `"latest"` with the resolved version like `"16.1.6"` or whatever it is). This prevents future `npm install` from upgrading to an incompatible version.

Then install all Payload packages in one command:
```bash
npm install payload@3.77.0 @payloadcms/next@3.77.0 @payloadcms/db-postgres@3.77.0 @payloadcms/richtext-lexical@3.77.0 graphql sharp --legacy-peer-deps
```

`--legacy-peer-deps` is required for React 19 peer dep conflicts (known temporary issue). All `@payloadcms/*` packages MUST be pinned at exactly `3.77.0` — mixed versions cause runtime errors.

**Step 5 — Verify route restructure:**

After all changes, verify:
- `app/layout.tsx` does NOT exist (deleted)
- `app/page.tsx` does NOT exist (deleted)
- `app/(marketing)/layout.tsx` exists and imports `"../globals.css"`
- `app/(marketing)/page.tsx` exists and all `@/components/*` imports are unchanged
  </action>
  <verify>
1. `ls app/layout.tsx` should return "No such file" (original is deleted)
2. `ls app/page.tsx` should return "No such file" (original is deleted)
3. `ls app/(marketing)/layout.tsx` should exist
4. `ls app/(marketing)/page.tsx` should exist
5. `grep "globals.css" "app/(marketing)/layout.tsx"` should show `../globals.css`
6. `ls next.config.ts` should return "No such file" (renamed to .mjs)
7. `ls next.config.mjs` should exist
8. `grep "@payload-config" tsconfig.json` should show the path alias
9. `grep '"next"' package.json` should show a pinned version (not "latest")
10. `node -e "require('payload')"` should not throw (package installed)
  </verify>
  <done>
Files restructured: `app/(marketing)/layout.tsx` and `app/(marketing)/page.tsx` exist, originals deleted. `next.config.mjs` wraps with `withPayload`. `tsconfig.json` has `@payload-config` alias. Next.js is version-pinned. All Payload packages installed at 3.77.0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Payload config, Users collection, and (payload) route group boilerplate</name>
  <files>
    payload.config.ts
    src/collections/Users.ts
    app/(payload)/layout.tsx
    app/(payload)/custom.scss
    app/(payload)/admin/importMap.js
    app/(payload)/admin/[[...segments]]/page.tsx
    app/(payload)/admin/[[...segments]]/not-found.tsx
    app/(payload)/api/[...slug]/route.ts
    src/migrations/.gitkeep
  </files>
  <action>
**Step 1 — Create Users collection:**

Create `src/collections/Users.ts` with this exact content:

```typescript
import type { CollectionConfig } from 'payload'

export const Users: CollectionConfig = {
  slug: 'users',
  auth: true,
  admin: {
    useAsTitle: 'email',
  },
  fields: [],
}
```

This is the minimal collection needed for admin login. The `auth: true` flag enables Payload's built-in authentication on this collection.

**Step 2 — Create payload.config.ts at project root:**

Create `payload.config.ts` at the project root (NOT in `src/`) with this exact content:

```typescript
import path from 'path'
import { buildConfig } from 'payload'
import { fileURLToPath } from 'url'
import { postgresAdapter } from '@payloadcms/db-postgres'
import { lexicalEditor } from '@payloadcms/richtext-lexical'
import sharp from 'sharp'

import { Users } from './src/collections/Users'

const filename = fileURLToPath(import.meta.url)
const dirname = path.dirname(filename)

export default buildConfig({
  admin: {
    user: 'users',
    importMap: {
      baseDir: path.resolve(dirname),
    },
  },
  collections: [Users],
  editor: lexicalEditor(),
  secret: process.env.PAYLOAD_SECRET || '',
  typescript: {
    outputFile: path.resolve(dirname, 'payload-types.ts'),
  },
  db: postgresAdapter({
    pool: {
      connectionString: process.env.DATABASE_URI || '',
    },
    push: false,
    migrationDir: './src/migrations',
  }),
  sharp,
  plugins: [],
})
```

**CRITICAL settings:**
- `push: false` — LOCKED decision from STATE.md. Must be set from day one. Never use push mode against Supabase.
- `migrationDir: './src/migrations'` — LOCKED decision from STATE.md.
- `admin.user: 'users'` — Points to the Users collection for admin authentication.
- `importMap.baseDir: path.resolve(dirname)` — Required so Payload can resolve component paths relative to config.
- `typescript.outputFile` — Places generated types at project root.

**Step 3 — Create `src/migrations/` directory:**

```bash
mkdir -p src/migrations
touch src/migrations/.gitkeep
```

This must exist before any `migrate:create` command runs.

**Step 4 — Create all `(payload)` route group files:**

Create the following directory structure and files. These are boilerplate from Payload's official template — do NOT modify them.

**`app/(payload)/layout.tsx`:**
```typescript
/* THIS FILE WAS GENERATED AUTOMATICALLY BY PAYLOAD. */
/* DO NOT MODIFY IT BECAUSE IT COULD BE REWRITTEN AT ANY TIME. */
import config from '@payload-config'
import '@payloadcms/next/css'
import type { ServerFunctionClient } from 'payload'
import { handleServerFunctions, RootLayout } from '@payloadcms/next/layouts'
import React from 'react'

import { importMap } from './admin/importMap.js'
import './custom.scss'

type Args = {
  children: React.ReactNode
}

const serverFunction: ServerFunctionClient = async function (args) {
  'use server'
  return handleServerFunctions({
    ...args,
    config,
    importMap,
  })
}

const Layout = ({ children }: Args) => (
  <RootLayout config={config} importMap={importMap} serverFunction={serverFunction}>
    {children}
  </RootLayout>
)

export default Layout
```

**`app/(payload)/custom.scss`:** Empty file (placeholder for admin CSS customization).

**`app/(payload)/admin/importMap.js`:**
```javascript
import { CollectionCards as CollectionCards_f9c02e79a4aed9a3924487c0cd4cafb1 } from '@payloadcms/next/rsc'

export const importMap = {
  '@payloadcms/next/rsc#CollectionCards': CollectionCards_f9c02e79a4aed9a3924487c0cd4cafb1,
}
```

**`app/(payload)/admin/[[...segments]]/page.tsx`:**
```typescript
/* THIS FILE WAS GENERATED AUTOMATICALLY BY PAYLOAD. */
/* DO NOT MODIFY IT BECAUSE IT COULD BE REWRITTEN AT ANY TIME. */
import type { Metadata } from 'next'

import config from '@payload-config'
import { RootPage, generatePageMetadata } from '@payloadcms/next/views'
import { importMap } from '../importMap'

type Args = {
  params: Promise<{
    segments: string[]
  }>
  searchParams: Promise<{
    [key: string]: string | string[]
  }>
}

export const generateMetadata = ({ params, searchParams }: Args): Promise<Metadata> =>
  generatePageMetadata({ config, params, searchParams })

const Page = ({ params, searchParams }: Args) =>
  RootPage({ config, params, searchParams, importMap })

export default Page
```

**`app/(payload)/admin/[[...segments]]/not-found.tsx`:**
```typescript
/* THIS FILE WAS GENERATED AUTOMATICALLY BY PAYLOAD. */
/* DO NOT MODIFY IT BECAUSE IT COULD BE REWRITTEN AT ANY TIME. */
import config from '@payload-config'
import { NotFoundPage } from '@payloadcms/next/views'
import { importMap } from '../importMap'

const NotFound = () => NotFoundPage({ config, importMap })
export default NotFound
```

**`app/(payload)/api/[...slug]/route.ts`:**
```typescript
/* THIS FILE WAS GENERATED AUTOMATICALLY BY PAYLOAD. */
/* DO NOT MODIFY IT BECAUSE IT COULD BE REWRITTEN AT ANY TIME. */
import config from '@payload-config'
import '@payloadcms/next/css'
import {
  REST_DELETE,
  REST_GET,
  REST_OPTIONS,
  REST_PATCH,
  REST_POST,
  REST_PUT,
} from '@payloadcms/next/routes'

export const GET = REST_GET(config)
export const POST = REST_POST(config)
export const DELETE = REST_DELETE(config)
export const PATCH = REST_PATCH(config)
export const PUT = REST_PUT(config)
export const OPTIONS = REST_OPTIONS(config)
```

**Step 5 — Verify build compiles:**

Run `npm run build` to verify the project compiles. Note: the build may warn about missing `DATABASE_URI` or `PAYLOAD_SECRET` — this is expected and will be resolved in Plan 01-02. The build should still complete successfully (Payload handles missing env vars gracefully at build time by using the empty string fallback).

If `npm run build` fails due to missing env vars, create a minimal `.env.local` with placeholder values:
```
DATABASE_URI=postgresql://placeholder:placeholder@localhost:5432/placeholder
PAYLOAD_SECRET=a]b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7
```
These are non-functional placeholders solely to unblock the build verification.
  </action>
  <verify>
1. `ls payload.config.ts` should exist at project root
2. `ls src/collections/Users.ts` should exist
3. `ls src/migrations/.gitkeep` should exist
4. `ls "app/(payload)/layout.tsx"` should exist
5. `ls "app/(payload)/custom.scss"` should exist
6. `ls "app/(payload)/admin/importMap.js"` should exist
7. `ls "app/(payload)/admin/[[...segments]]/page.tsx"` should exist
8. `ls "app/(payload)/admin/[[...segments]]/not-found.tsx"` should exist
9. `ls "app/(payload)/api/[...slug]/route.ts"` should exist
10. `grep "push: false" payload.config.ts` should match
11. `grep "migrationDir" payload.config.ts` should show `./src/migrations`
12. `grep "collections: \[Users\]" payload.config.ts` should match
13. `npm run build` completes without errors (may need placeholder .env.local)
  </verify>
  <done>
`payload.config.ts` exists at project root with `push: false`, `migrationDir: './src/migrations'`, and Users collection. All 7 `(payload)` route group files are created. `src/migrations/` directory exists. `npm run build` compiles both route groups without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Route group restructure: existing landing page moved to `(marketing)` route group. Payload CMS 3.77.0 installed with all dependencies. `(payload)` route group created with admin panel and REST API boilerplate. `next.config.mjs` wraps with `withPayload`. `payload.config.ts` at project root with `push: false` and Users collection for admin auth.
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and visit `http://localhost:3000/`
   - The landing page should render identically to before: fonts load, animations play, all sections visible, no layout shifts or missing styles
2. Visit `http://localhost:3000/admin`
   - Should show the Payload admin panel (may show a database connection error or login screen depending on whether DATABASE_URI is configured — either is acceptable for this checkpoint)
   - The admin panel should NOT have Tailwind styles bleeding in (no broken typography, no missing button styles from the admin UI framework)
3. Stop the dev server and run `npm run build`
   - Build should complete without errors
  </how-to-verify>
  <resume-signal>Type "approved" if the landing page looks correct and admin panel loads without CSS bleed, or describe any issues seen.</resume-signal>
</task>

</tasks>

<verification>
1. `app/layout.tsx` and `app/page.tsx` do NOT exist (deleted after move)
2. `app/(marketing)/layout.tsx` imports `"../globals.css"` and contains all font setup + metadata
3. `app/(marketing)/page.tsx` exists with unchanged component imports
4. `next.config.mjs` exists with `withPayload` wrapper
5. `next.config.ts` does NOT exist (deleted after rename)
6. `tsconfig.json` has `@payload-config` alias pointing to `./payload.config.ts`
7. `payload.config.ts` has `push: false` and `migrationDir: './src/migrations'`
8. All 7 `(payload)` route group files exist
9. `src/collections/Users.ts` exists with `auth: true`
10. `src/migrations/.gitkeep` exists
11. `npm run build` completes without errors
12. No CSS from `globals.css` reaches the `(payload)` route group
</verification>

<success_criteria>
- Landing page at `/` renders identically to before the restructure — all fonts, animations, and layout intact
- Payload admin panel at `/admin` is accessible (login screen or DB error page, not a 404)
- No CSS bleed: Payload's admin UI is not affected by Tailwind styles
- `npm run build` completes without errors covering both route groups
- `payload.config.ts` has `push: false` and `migrationDir: './src/migrations'` set from day one
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-01-SUMMARY.md`
</output>
