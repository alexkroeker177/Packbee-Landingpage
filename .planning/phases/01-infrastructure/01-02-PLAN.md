---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .env.local
  - src/migrations/
  - payload.config.ts
  - payload-types.ts
autonomous: false

user_setup:
  - service: supabase
    why: "Dedicated PostgreSQL instance for Payload CMS data"
    env_vars:
      - name: DATABASE_URI
        source: "Supabase Dashboard -> Project -> Settings -> Database -> Connection pooling -> Transaction mode. Format: postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true"
    dashboard_config:
      - task: "Create a new Supabase project dedicated to the landing page CMS (separate from the main PackBee project)"
        location: "https://supabase.com/dashboard -> New Project"

must_haves:
  truths:
    - "Payload connects to the dedicated Supabase PostgreSQL instance without connection errors"
    - "Running `npx payload migrate` applies the initial schema and creates tables in the database"
    - "A migration file exists in `src/migrations/` and is committed to git"
    - "A media upload through the admin panel saves to the local filesystem without errors"
    - "An admin user can be created and log in to the Payload admin panel at `/admin`"
  artifacts:
    - path: ".env.local"
      provides: "Database connection string and Payload secret"
      contains: "DATABASE_URI"
    - path: "src/migrations/"
      provides: "Initial migration file with Payload schema DDL"
    - path: "payload-types.ts"
      provides: "Auto-generated TypeScript types from Payload config"
      contains: "UsersSelect"
  key_links:
    - from: "payload.config.ts"
      to: "Supabase PostgreSQL"
      via: "DATABASE_URI env var -> postgresAdapter pool.connectionString"
      pattern: "process\\.env\\.DATABASE_URI"
    - from: "src/migrations/*.ts"
      to: "Supabase PostgreSQL"
      via: "npx payload migrate runs the SQL in migration files against the database"
---

<objective>
Connect Payload CMS to a dedicated Supabase PostgreSQL instance, create and run the initial migration, configure media uploads, generate TypeScript types, and verify the full admin login flow works end-to-end.

Purpose: Completes the infrastructure foundation so that the Payload admin panel is fully functional — content editors can log in, and the database schema is managed through tracked migration files (not push mode).

Output: A working Payload admin panel connected to Supabase, with initial migration committed, media uploads functional, and an admin user created.
</objective>

<execution_context>
@/Users/alexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure environment, add Media collection, run initial migration, and generate types</name>
  <files>
    .env.local
    payload.config.ts
    src/collections/Media.ts
    src/migrations/ (new migration file)
    payload-types.ts (auto-generated)
  </files>
  <action>
**Step 1 — Create `.env.local` with real credentials:**

Create `.env.local` at the project root. If placeholder values were added during Plan 01-01, replace them with real values.

```bash
# Supabase PostgreSQL - transaction pooler (port 6543, NOT direct 5432)
# IMPORTANT: Must use transaction pooler with ?pgbouncer=true (LOCKED decision from STATE.md)
DATABASE_URI=postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true

# Payload CMS secret - must be 32+ chars, cryptographically random
# Generate with: openssl rand -base64 32
PAYLOAD_SECRET=

# Server URL for Payload SEO plugin and live preview
NEXT_PUBLIC_SERVER_URL=http://localhost:3000
```

**The user must provide the `DATABASE_URI` value** from their Supabase Dashboard (Project -> Settings -> Database -> Connection pooling -> Transaction mode). The connection string MUST:
- Use port `6543` (transaction pooler), NOT port `5432` (direct connection)
- End with `?pgbouncer=true`
- Be from a **dedicated** Supabase project (not the main PackBee product database)

Generate `PAYLOAD_SECRET` with:
```bash
openssl rand -base64 32
```

**Step 2 — Create Media collection for local filesystem uploads:**

Create `src/collections/Media.ts`:

```typescript
import type { CollectionConfig } from 'payload'

export const Media: CollectionConfig = {
  slug: 'media',
  access: {
    read: () => true,
  },
  upload: {
    staticDir: 'media',
    mimeTypes: ['image/*'],
  },
  fields: [
    {
      name: 'alt',
      type: 'text',
      required: true,
    },
  ],
}
```

The `staticDir: 'media'` tells Payload to store uploaded files in a `media/` directory at the project root. The `read: () => true` access control makes media files publicly readable (needed for blog images).

**Step 3 — Add Media collection to payload.config.ts:**

Update `payload.config.ts` to import and include the Media collection:

```typescript
import { Media } from './src/collections/Media'
```

And update the `collections` array:
```typescript
collections: [Users, Media],
```

**Step 4 — Add `media/` directory and update `.gitignore`:**

```bash
mkdir -p media
```

Add to `.gitignore`:
```
# Payload media uploads (local filesystem)
media/*
!media/.gitkeep
```

Then create `.gitkeep`:
```bash
touch media/.gitkeep
```

This ensures the directory exists in git but uploaded files are not committed.

**Step 5 — Verify database connection:**

```bash
npm run dev
```

Watch the console output. If `DATABASE_URI` is configured correctly, Payload will connect to Supabase. If it shows a connection error, the `DATABASE_URI` value needs to be fixed before proceeding.

**Step 6 — Create and run the initial migration:**

With the dev server stopped and `DATABASE_URI` configured:

```bash
npx payload migrate:create --name initial
```

This generates a migration file in `src/migrations/` (e.g., `20260218_000000_initial.ts`) containing the SQL DDL for all Payload internal tables plus the Users and Media collection tables.

Verify the migration file was created:
```bash
ls src/migrations/
```

Then apply the migration:
```bash
npx payload migrate
```

This runs the generated SQL against the Supabase database, creating all tables.

**Step 7 — Generate TypeScript types:**

```bash
npx payload generate:types
```

This creates `payload-types.ts` at the project root (as configured in `typescript.outputFile`). This file should be committed to git.

**Step 8 — Create the first admin user:**

Start the dev server:
```bash
npm run dev
```

Visit `http://localhost:3000/admin`. Payload will show a "Create First User" form (since no users exist yet). Create an admin user with email and password. This confirms the full flow works: database connection, schema, and admin authentication.
  </action>
  <verify>
1. `.env.local` exists with `DATABASE_URI`, `PAYLOAD_SECRET`, and `NEXT_PUBLIC_SERVER_URL`
2. `src/collections/Media.ts` exists with `upload` configuration
3. `grep "Media" payload.config.ts` shows the Media collection is imported and included
4. `ls src/migrations/*.ts` shows at least one migration file (the initial migration)
5. `npx payload migrate:status` shows migrations are up to date (all applied)
6. `ls payload-types.ts` exists at project root
7. `grep "UsersSelect" payload-types.ts` confirms Users type was generated
8. `ls media/.gitkeep` exists
9. `grep "media" .gitignore` shows the media directory is gitignored
10. `npm run build` completes without errors
  </verify>
  <done>
`.env.local` configured with Supabase transaction pooler connection. Media collection created with local filesystem storage. Initial migration generated in `src/migrations/` and applied to Supabase. `payload-types.ts` generated and committed. `npm run build` passes. Media uploads directory exists and is gitignored.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Payload CMS fully connected to a dedicated Supabase PostgreSQL instance. Initial migration created and applied. Media collection configured for local filesystem uploads. TypeScript types generated. Admin user creation flow tested.
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and visit `http://localhost:3000/admin`
   - Should show the login screen (or "Create First User" if no user created yet)
   - Log in with the admin credentials (or create a first user)
   - The dashboard should load without errors

2. Test media upload:
   - In the admin panel, navigate to "Media" collection
   - Upload an image (any JPG or PNG)
   - The upload should succeed — the image should appear in the media list
   - Verify the file exists on disk in the `media/` directory

3. Visit `http://localhost:3000/` to confirm the landing page still works identically

4. Stop the dev server and run `npm run build` — should complete without errors

5. Verify migration tracking:
   - Run `npx payload migrate:status` — should show all migrations applied
   - Check `src/migrations/` — should contain at least one `.ts` migration file
  </how-to-verify>
  <resume-signal>Type "approved" if admin login works, media upload saves to disk, landing page is unchanged, and build passes. Describe any issues if not.</resume-signal>
</task>

</tasks>

<verification>
1. `.env.local` has valid `DATABASE_URI` pointing to Supabase transaction pooler (port 6543, `?pgbouncer=true`)
2. `.env.local` has cryptographically random `PAYLOAD_SECRET` (32+ chars)
3. `payload.config.ts` has `push: false` (unchanged from Plan 01-01)
4. `payload.config.ts` has `collections: [Users, Media]`
5. `src/migrations/` contains the initial migration file
6. `npx payload migrate:status` shows all migrations applied
7. `payload-types.ts` exists and contains generated types
8. `media/` directory exists, `.gitkeep` present, uploads gitignored
9. Admin user can log in at `/admin`
10. Media upload via admin panel saves file to `media/` on disk
11. `/` still renders the landing page identically
12. `npm run build` completes without errors
</verification>

<success_criteria>
- Payload admin panel at `/admin` is fully functional: login, dashboard navigation, collection management
- Media uploads through the admin panel save to the local `media/` directory
- Initial migration exists in `src/migrations/` and is applied to the Supabase database
- `push: false` remains set — no schema changes happen outside migration files
- `payload-types.ts` is generated and committed
- Landing page at `/` is completely unchanged
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-02-SUMMARY.md`
</output>
